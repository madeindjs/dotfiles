#!/usr/bin/env node
// @ts-check

// @ts-ignore
const { JIRA_URL, JIRA_EMAIL, JIRA_API_KEY } = process.env;
if (!JIRA_URL) throw Error("JIRA_URL is not defined");
if (!JIRA_EMAIL) throw Error("JIRA_EMAIL is not defined");
if (!JIRA_API_KEY) throw Error("JIRA_API_KEY is not defined");

main().catch(console.error);

async function main() {
  // @ts-ignore
  for (const id of process.argv.slice(2)) {
    const issue = await fetchIssue(id);
    console.log(issue);
    console.log(formatIssue(issue, true));
  }
}

async function fetchIssue(id) {
  // @ts-ignore
  const auth = Buffer.from(`${JIRA_EMAIL}:${JIRA_API_KEY}`).toString("base64");
  const res = await fetch(`${JIRA_URL}/rest/api/3/issue/${id}`, {
    headers: {
      Authorization: `Basic ${auth}`,
      "Content-Type": "application/json",
    },
  });
  if (!res.ok) throw Error(await res.text());
  return res.json();
}

function formatIssue(issue, displayStatus = false) {
  let text = `[${issue.fields.summary}](${JIRA_URL}/browse/${issue.key})`;
  if (displayStatus) text += `, moved to "${issue.fields.status.name}"`;
  return text;
}
